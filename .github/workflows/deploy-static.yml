name: Deploy static site to GCS

on:
  push:
    branches: [ main ]

permissions:
  contents: read

env:
  BUCKET: ${{ secrets.GCS_BUCKET }}   # set this to the bucket created by Terraform
  MAIN_PAGE: index.html
  ERROR_PAGE: 404.html

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Auth to Google Cloud (JSON key)
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.GCP_SA_KEY }}

      - name: Setup gcloud
        uses: google-github-actions/setup-gcloud@v2

      - name: Ensure website config
        run: |
          gsutil web set -m "${MAIN_PAGE}" -e "${ERROR_PAGE}" "gs://${BUCKET}"

      - name: Sync files to GCS
        run: |
          gsutil -m rsync -r -d ./ "gs://${BUCKET}"
          gsutil -m setmeta -h "Cache-Control:no-store" "gs://${BUCKET}/**/*.html" || true
          gsutil -m setmeta -h "Cache-Control:public,max-age=3600" "gs://${BUCKET}/**/*.{css,js,png,jpg,jpeg,svg,webp,ico,json}" || true

      - name: Show website URL
        run: |
          echo "Deployed to: http://storage.googleapis.com/${BUCKET}/index.html"
